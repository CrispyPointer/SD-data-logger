<h1 align="center">SD Logger: Low Power Data Logger</h1>

<div align="center">

*This project is an **open source** low-power and size-constrained data logger. The puspose of this device is to provive an simple-to-use, low-power solution for logging serial data from your projects. The **SODAQ(SD) Logger** provides a simple serial serial interface to log UART from a **Device Under Test (DUT)** into a LGA8-packaged micro SD card.*

</div>

---

### Release Notes:

##### 1.0 Update:

### Repository Contents
- /Docs - Datasheets, additional product information
- /Firmware - Complete firmware for the Logger, `.ioc` code generate file. 
- /Hardware - Hardware design files for the Openlog PCB. These files were designed in Altium Designer.

### 1. Project description

#### 1.1 Overview
![SD Logger](Docs\Images\SD_Logger_3D.png)

#### 1.2 Hardware 
###### Power
The SD Logger runs at the following setting:
Characteristic | Power Rating
---|---
**VCC input** | **Direct 3.3V or 3.3V - 8.5V from an external battery** 
**RXI input** | *3.3V* (*Although the pin is 5V tolerant, 3.3V is recommended input level*)
**TXO output** | 3.3V
**Active Current Draw** | ~4.5mA-6mA (buffering), ~30mA(writing to SD card)
**Idle Current Draw** | **~21ÂµA** 

###### Microcontroller
The SD Logger runs off of an onboard STM32L412CBT6P, running at 48MHz. The MCU embed high-speed memories (128KByte of Flash and 40KByte of SRAM).
###### Interface
**Serial UART**
The primary interface with the SD Logger is the UART header on the board edge. Additionally, there are also a custom tag-connector with pogo pins on the board to make it become an adapter board that can be easily plugged into any product with the tag connect pads on it. An **FPC connector** is also integrated on the board so it could be connect to other boards by using a `0.5mm` flat cable. 

**SPI**
Single SPI is used for the external FRAM `(6MHz)` and the microSD card `(24MHz)`. To communicate, both the FRAM and the microSD card requires SPI pins. Users can also update the Logger's configuration via the config.txt file.

**USB Full Speed 2.0**
The Mass Storage Class (MSC) allows the Logger to appear as a mass storage device to a host computer (in this case as a USB memory stick). Users can switch the Logger USB function on by clipping the Logger with the 2x5 pins clip clamp that connect to a USB cable.

**Status LED**
There is a status LED on the Logger to help with troubleshooting. A tiny switch is placed in the between the LED and the pinout so that under normal working period, the LED does not consume extra power.  

#### 1.3 Firmware

###### Prerequisites:
> **Language:** C
> **Code Generator:** STM32CubeMx generate project files under *Makefile* toolchain with assigned pinouts and configurations.
> **Compiler:** ARM-None-Eabi-gcc toolchain
> **Flash tool:** STLink programmer

The provided firmware contains the source code of the device, mainly including these functions:

- **Receive data:** Data received through UART protocol with configurable baudrate (Defaul at 115200bps).
- **Go into / Wake up from Low power mode:** After a certain `user define` seconds, the logger will go into low power **stop mode 1** to reduce power consumption. During sleep period, the Logger can be woken up by detecting a falling edge on the **USART** RX line and the data reception goes on normally.
- **Receive / Synchronize data** Received data will be buffer to the external **250KB** FRAM before transferring to the SD Card. During the logging period, the data location will be updated constantly into a reserved area of the FRAM. In case of power outage or the DUT stop sending data before the Logger reaches its buffer threshold, the next time during booting up, the logger will synchronize all the previous data from the FRAM buffer to the SD card before running into logging mode.
- **Generate logging file with FATfs**: At the beginning of every logging section, the Logger will generate a logging file numbered from 0 to 65534. All the logging data will be appended into this file using `SPI SD` protocol and `FATfs` library.
- **USB MSC for extracting data**: One of the most important features of the Logger is to provide a Full-Speed (FS) *48MHz* `USB Mass Storage Class (USB MSC)` for data extraction. During boot up period, the Logger will check if there is a USB cable plugged in to switch into a USB memory stick so the users can extract all the data as if they plug-in a normal SD card.

**Note:** The project are all implemented based on STM32HAL, so the corresponding `.ioc` file is provided, which can be opened with STM32CubeMX to generate the corresponding STM32 project file. During the developing process of the SD Logger, the project files was first generated by STM32CubeMx with `Makefile` toolchain. `GNU Arm Embedded Toolchain` is also required to compile the source code. Finally, `OpenOCD` or `STM32CubeProgrammer` can be used to flash the built firmware into the device.

### 2. License Information